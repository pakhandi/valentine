<html>
<head>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/jquery-ui-1.10.4.custom.min.css">
	<link rel="stylesheet" href="css/home.css">

	<script type="text/javascript" src="js/jquery.min.js"> </script>
	<script type="text/javascript" src="js/jquery-ui-1.10.4.custom.min.js"> </script>
	
	<script type="text/javascript" src="js/tooltip.js"> </script>
	<script src="js/crypt.js"></script>
	<script>
	var selection=[{'visible':false},{'visible':false},{'visible':false},{'visible':false}]
	$(function() {
		$( ".name-search" ).autocomplete({
			source: "http://pclub.in/valentine/server/index.php/app/typeahead"
		}).data("ui-autocomplete")._renderItem = function( ul, item ) {
			
			return $( "<li>" )
			.attr( "data-value", item.value )
			.append( $( "<a>" ).text( item.name+"      "+item.program+'/'+item.department ) )
			.appendTo( ul );
		};
		$( ".name-search" ).on( "autocompleteselect", function( event, ui ) {
			
			fillVoid(ui.item)
		});

	});
	</script>
	<script>
	$(document).ready(function(){
		$('.inactive').tooltip();
		$('.bin').click(function(e){del(e)});
		init();
		$('.submit-btn').click(function(){submit()})
	});
	function init(){
		keyPair = cryptico.generateRSAKey(atob(sessionStorage.str), 1024)
		voids = $('.mm');
		for (var i = voids.length - 1; i >= 0; i--) {
			one_void = $(voids[i]);
			selection[i].handle = one_void;
		};
		$('.mm').hide();

		//get the prior selection and count of selectors if any
		$.get( "http://pclub.in/valentine/server/index.php/app/crushes", function( data ) {
			if(data.length==0){
		// $('.empty-selection').show();

			}
				else
					{
						data = data[0]
						$('.bin').hide();
						$('.submit-btn').hide();
						$('.ui-autocomplete-input').attr('disabled',1);
						$('.ui-autocomplete-input').attr('placeholder',"You cant select any more people")

						
						rolls = keyPair.decrypt(data.data)
						rolls = JSON.parse(rolls);
						for(roll in rolls){
							$.get("http://pclub.in/valentine/server/index.php/app/details",{rollno:rolls[roll]},function(data1){fillVoid(data1[0])},"json");
						}
					}
				},"json");
		$.get('http://pclub.in/valentine/server/index.php/app/mydetails',function(data){
			myRoll = data[0].rollno
			myGender = data[0].gender
		},"json")
		def = cryptico.generateRSAKey("default",1024)
		pkey = cryptico.publicKeyString(def)
		mycount = 0
		$.get('http://pclub.in/valentine/server/index.php/app/count',function(data){
			$('.anon-count').text(data)

		})
		$.get('http://pclub.in/valentine/server/index.php/app/loggedin',function(data){
			if(data.search("TRUE") ==-1){
				window.location="http://pclub.in/valentine"
			}
		})

	}

	function del(event){

		curID = $(event.target).data().id
		console.log(curID)
		makeInvisible(curID)
		//delete curID
	}
	function makeVisible(id){
		selection[id].handle.show();
		selection[id].visible = true
	}
	function makeInvisible(id){
		selection[id].handle.hide();
		selection[id].visible = false;
		selection[id].rollno = -1
	}
	function fillVoid(person){
		console.log(person)
		aa= person
		for(item in selection){
			if(! selection[item].visible){
				selection[item].rollno=person.rollno;
				selection[item].publickey=person.publickey;
				selection[item].handle.find('.selection-detail').text(person.department+"/"+person.program)
				selection[item].handle.find('.selection-name').text(person.name.toUpperCase())
				selection[item].handle.find('.selection-image').attr('src','http://oa.cc.iitk.ac.in:8181/Oa/Jsp/Photo/'+person.rollno.toUpperCase()+'_0.jpg')

				makeVisible(item);
				break;
			}
		}
	}
	function addTemp(person){
		for(item in selection){
			if(selection[item].visible){
				subm.push(selection[item].rollNo)
			}
		}
	}
	function submit(){
		//post the selection array
		if(myRoll == -1){
			alert("ERROR rollNO not defeines");
			return;
		}
		
		subm=[]
		rollno=[null,null,null,null]
		data=[null,null,null,null]
		for(item in selection){
			if(selection[item].visible){
				subm.push(selection[item].rollno)
				rollno[item] = selection[item].rollno
				if(selection[item].publickey.search("default")==-1)
					data[item] = cryptico.encrypt(myRoll,selection.publickey)
				else
					data[item] = cryptico.encrypt(myRoll,pkey)

				if(data[item].status != "success"){
					console.log(data[item]);
					return;
				}
				data[item] = data[item].cipher

			}

		}
		$.post('http://pclub.in/valentine/server/index.php/app/addto',{rollno1:rollno[0],	rollno2:rollno[1],	rollno3:rollno[2],	rollno4:rollno[3],	data1:data[0],	data2:data[1],	data3:data[2],	data4:data[3]},function(){})
		enc = keyPair.encrypt(JSON.stringify(subm))
		$.post('http://pclub.in/valentine/server/index.php/app/addfrom',{data:enc},function(){
			$('.bin').hide();
						$('.submit-btn').hide();
		})


			console.log(subm)
	}
	
	</script>
</head>
<body>
	<div class="header">
	</div>
	<a href="http://pclub.in/valentine/server/index.php/app/logout"><div class="btn-default logout">Logout</div></a>
	<div class="container">
		<div class="row">
			<div class="col-lg-offset-1 col-lg-10 col-xs-12">
				<div class="row">
					<img src="images/logo_white.png" style='margin-left:25em;height:7em'/>
					<img src="images/title.png" style='height:2.5em;' />
				</div>
				<div class="row">
					<ul class="nav nav-pills nav-justified">
						<li><a class="active" href="#">Home</a></li>
						<li><a class="inactive" data-toggle="tooltip" data-placement="bottom" title="To be announced on 14th Feb, 6 PM" >View Results</a></li>
						<li><a href="#">How it Works</a></li>
						<li><a href="#">Privacy</a></li>

					</ul>
				</div>
				<div class="row">
					<div class="col-xs-12">
						<input type="text" class="form-control name-search" placeholder="Start typing the name....">
					</div>
				</div>
				<div class="row selections">
					<div class="col-xs-6">
						<div class="selection mm" data-id="0">
							<img src="images/bin.png" alt="" class="bin" data-id="0">
							<img src="images/sample.jpg" alt="" class="img-rounded pull-left selection-image">
							<div class="pull-left selection-wrapper">
								<div class="selection-name" id='name-1'>
									Parineeti Chopra
								</div>
								<div class="selection-detail" id='dep-1'>
									BTech/CSE
								</div>
							</div>
						</div>
						<div class="selection empty-selection"></div>
					</div>
					<div class="col-xs-6">
						<div class="selection mm" data-id="1">
							<img src="images/bin.png" alt="" class="bin" data-id="1">

							<img src="images/sample.jpg" alt="" class="img-rounded pull-left selection-image">
							<div class="pull-left selection-wrapper">
								<div class="selection-name" id='name-2'>
									Parineeti Chopra
								</div>
								<div class="selection-detail" id='dep-2'>
									BTech/CSE
								</div>
							</div>
						</div>
						<div class="selection empty-selection"></div>

					</div>
					<div class="col-xs-6">
						<div class="selection mm" data-id="2">
							<img src="images/bin.png" alt="" class="bin" data-id="2">

							<img src="images/sample.jpg" alt="" class="img-rounded pull-left selection-image">
							<div class="pull-left selection-wrapper">
								<div class="selection-name" id='name-3'>
									Parineeti Chopra
								</div>
								<div class="selection-detail" id='dep-3'>
									BTech/CSE
								</div>
							</div>
						</div>
						<div class="selection empty-selection"></div>

					</div>
					<div class="col-xs-6">
						<div class="selection mm" data-id="3">
							<img src="images/bin.png" alt="" class="bin" data-id="3">

							<img src="images/sample.jpg" alt="" class="img-rounded pull-left selection-image ">
							<div class="pull-left selection-wrapper">
								<div class="selection-name" id='name-4'>
									Parineeti Chopra
								</div>
								<div class="selection-detail" id='dep-4'>
									BTech/CSE
								</div>
							</div>
						</div>
						<div class="selection empty-selection"></div>
						
					</div>
				</div>
				<div class="row">
					<button type="button" class="btn btn-default submit-btn">Submit</button>
				</div>
				<div class="row anon-selections-wrapper">
					<div class="col-xs-12 anon-selections">
						Someone wants you to be their valentine...
					</div>
					<div class="col-xs-3">
						<img src="images/heart.png" alt="" class="img-rounded img-responsive img-anon">
					</div>
					<div class="col-xs-3">
						<img src="images/heart.png" alt="" class="img-rounded img-responsive img-anon">
					</div>
					<div class="col-xs-3">
						<img src="images/heart.png" alt="" class="img-rounded img-responsive img-anon">
					</div>
					<div class="col-xs-3 anon-count">
						<p>and 3 others...</p>
					</div>
				</div>
			</div>
		</div>
		
	</div>	
</body>
</html>
